<!DOCTYPE html>
<html lang="en">
  <head>
    <title>FunkHouse Ticket - <%=name%></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.8" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#f5c3fb" />
    <link
      href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"
    />
    <link rel="stylesheet" href="/ticket/style.css" />
    <style></style>
  </head>
  <body scroll="no">
    <!-- Heading of the ticket -->
    <div class="ticket" style="z-index: 1">
      <div class="holes-top"></div>
      <div class="title">
        <p class="cinema"><%= name %></p>
        <% if(checked === true){ %>
        <p class="movie-title" style="color: #f71735">Использован</p>
        <% } else{ %>
        <p class="movie-title" style="color: #488b49">Не использован</p>
        <% } %>
      </div>
      <div class="poster">
        <img src="../splash.png" alt="Funkhouse" />
      </div>
      <div class="info">
        <table>
          <tr>
            <th>ЦЕНА</th>
            <th>НОМЕР БИЛЕТА</th>
            <th>СОЦ. СЕТЬ</th>
          </tr>
          <tr>
            <td><%= price %></td>
            <td><%= id %></td>
            <td><%= social %></td>
          </tr>
        </table>
      </div>
      <div class="holes-lower"></div>
    </div>

    <!-- Icon if checked -->
    <div id="ticket_checked" style="display: none">
      <svg width="40" height="40" transform="scale(2)">
        <circle
          fill="none"
          stroke="#3BA99C"
          stroke-width="2.5"
          cx="20"
          cy="20"
          r="19"
          stroke-linecap="round"
          transform="rotate(-9 20 20)"
          class="circle"
        ></circle>
        <polyline
          fill="none"
          stroke="#21897E"
          stroke-width="3"
          points="8.8,21.4 17.3,28.4 30.4,13.8"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="tick"
        ></polyline>
      </svg>
      <h2>Билет проверен</h2>
    </div>

    <!-- After Cropline -->
    <div id="cropline" class="ticket" style="margin: 0 auto; z-index: 0">
      <div class="holes-lower"></div>
      <div id="serial" class="serial">
        <img style="height: 280px" src="/tickets/<%=qr%>/qr" alt="" />
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

    <script>
      const checked = JSON.parse("<%=checked%>");
      const code = "<%=qr%>";

      const serial = document.getElementById("cropline");
      const hammer = new Hammer(serial);
      const tearSound = new Audio("/ticket_tear.mp3");
    </script>

    <% if(isAdmin === true && checked === false) { %>
    <script>
      $(".movie-title")[0].text = "test";
      async function checkTicket() {
        const { data } = await (await fetch(`/tickets/${code}/check`)).json();
        if (data.success === true) {
          setTimeout(async () => {
            $("#ticket_checked").show();
            $(".movie-title")[0].innerHTML = "Использован";
          }, 350);
        } else {
          location.reload();
        }
      }

      hammer.on("swipeleft", function () {
        tearSound.play();
        serial.style.transition = "all 0.3s ease-out";
        serial.style.transform = "translateY(10%)";
        window.navigator.vibrate([20]);
        setTimeout(() => {
          serial.style.transform = "translate(-80%, 20%)";
          serial.style.opacity = "0";
          checkTicket();
        }, 350);
      });
      hammer.on("swiperight", function () {
        tearSound.play();
        serial.style.transition = "all 0.3s ease-out";
        serial.style.transform = "translateY(10%)";
        window.navigator.vibrate([20]);
        setTimeout(() => {
          serial.style.transform = "translate(80%, 20%)";
          serial.style.opacity = "0";
          checkTicket();
        }, 350);
      });
    </script>
    <% } else{ %>
    <script>
      hammer.on("swipe", function () {
        //tearSound.play();
        serial.style.transition = "all 0.15s ease-out";
        serial.style.transform = "translateY(10%)";
        window.navigator.vibrate([10]);
        setTimeout(() => {
          setTimeout(() => {
            serial.style.transform = "translate(-5%, 10%)";
            setTimeout(() => {
              serial.style.transform = "translate(5%, 10%)";
              window.navigator.vibrate([35, 30, 35, 30, 35]);
              setTimeout(() => {
                serial.style.transform = "translate(-5%, 10%)";
                setTimeout(() => {
                  serial.style.transform = "translate(5%, 10%)";
                  setTimeout(() => {
                    serial.style.transform = "translate(0%, 10%)";
                    setTimeout(() => {
                      serial.style.transform = "translate(0%, 0%)";
                    }, 120);
                  }, 100);
                }, 100);
              }, 100);
            }, 100);
          }, 150);
        }, 200);
      });
    </script>
    <% } %>
  </body>
</html>
