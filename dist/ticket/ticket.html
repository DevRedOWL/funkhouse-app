<!DOCTYPE html>
<html lang="en">
  <head>
    <title>FunkHouse Ticket - <%=name%></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.8" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#da532c" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="/icons/site.webmanifest" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#f5c3fb" />
    <link
      href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/vendor/meyer-reset.css" />
    <link rel="stylesheet" href="/ticket/style.css" />
    <script>
      const randomColor = (() => {
        const randomInt = (min, max) => {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        };

        const stringToColour = function (str) {
          var hash = 0;
          for (var i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
          }
          var colour = "#";
          for (var i = 0; i < 3; i++) {
            var value = (hash >> (i * 8)) & 0xff;
            colour += ("00" + value.toString(16)).substr(-2);
          }
          return colour;
        };

        // Color from id
        return stringToColour("<%=name%><%=id%>");

        // Hue
        // return (() => {
        //   var h = randomInt(66, 360);
        //   var s = randomInt(42, 98);
        //   var l = randomInt(40, 90);
        //   return `hsl(${h},${s}%,${l}%)`;
        // })();

        // Dark
        // let color = "#";
        // for (let i = 0; i < 3; i++)
        //   color += (
        //     "0" + Math.floor((Math.random() * Math.pow(24, 2)) / 2).toString(16)
        //   ).slice(-2);
        // return color;
      })();
    </script>
  </head>
  <body scroll="no">
    <!-- Heading of the ticket -->
    <div class="ticket" style="z-index: 2; opacity: 0">
      <div class="holes-top"></div>
      <div class="title">
        <p class="cinema"><%= name %></p>
        <% if(checked === true){ %>
        <p class="movie-title" style="color: #f71735">Использован</p>
        <% } else { %>
        <p class="movie-title" style="color: #488b49">Не использован</p>
        <% } %>
      </div>
      <div class="poster">
        <img src="/splash/splash.png" alt="Funkhouse" />
      </div>
      <div class="info">
        <table>
          <tr>
            <th>ЦЕНА</th>
            <th>НОМЕР БИЛЕТА</th>
            <th>СОЦ. СЕТЬ</th>
          </tr>
          <tr id="info-values">
            <td id="footer-price"><%= price %></td>
            <td id="footer-id"><%= id %></td>
            <td id="footer-social"><%= social %></td>
          </tr>
        </table>
      </div>
      <div class="holes-lower"></div>
    </div>

    <!-- Icon if checked -->
    <div id="ticket_checked" style="display: none">
      <svg width="40" height="40" transform="scale(2)">
        <circle
          fill="none"
          stroke="#ebebeb"
          stroke-width="2.5"
          cx="20"
          cy="20"
          r="19"
          stroke-linecap="round"
          transform="rotate(-9 20 20)"
          class="circle"
        ></circle>
        <polyline
          fill="none"
          stroke="#fff"
          stroke-width="3"
          points="8.8,21.4 17.3,28.4 30.4,13.8"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="tick"
        ></polyline>
      </svg>
      <h2 id="confirmed" style="color: #fff">Билет проверен</h2>
    </div>

    <!-- After Cropline -->
    <div
      id="cropline"
      class="ticket"
      style="margin: -1px auto 0 auto; z-index: 1; opacity: 0"
    >
      <div class="holes-lower"></div>
      <div id="serial" class="serial">
        <img src="/tickets/<%=qr%>/qr?bg=00000000" alt="" />
      </div>
    </div>
    <script src="/vendor/jq.js"></script>
    <script src="/vendor/hammer.js"></script>

    <script>
      $("document").ready(() => {
        document.documentElement.style.setProperty("--bg-color", randomColor);
        $(".ticket").css("opacity", 1);
      });
      const checked = JSON.parse("<%=checked%>");
      const code = "<%=qr%>";

      const serial = document.getElementById("cropline");
      const hammer = new Hammer(serial);
      const tearSound = new Audio("/ticket_tear.mp3");
      const noTearSound = new Audio("/bus_ticket_tear.mp3");
      const canVibrate = window?.navigator?.vibrate;
    </script>

    <% if(premium === true) { %>
    <!-- FIXME: Branding -->
    <script>
      $("document").ready(() => {
        $(".ticket").addClass("bg-gold");
        $(".movie-title").css("color", "#0e0e0e");
        $(".movie-title").text("Не использован");
        $(".cinema").css("color", "#785712");
        document.documentElement.style.setProperty("--bg-color", "#1e1e1e");
        $("svg").children()[0].setAttribute("stroke", "#b9861f");
        $("svg").children()[1].setAttribute("stroke", "#f4b32f");
        $("#confirmed").css("color", "#f4b32f");
        $("#footer-social").text("Premium");
        $("#info-values").css("color", "#fdb931");
        $(".branding").css("color", "#fefefe");
        $(".branding a").css("color", "#f4b32f");
      });
    </script>
    <% } %> <% if(isAdmin === true && checked === false || premium === true) {
    %>
    <script>
      $(".movie-title")[0].text = "test";
      async function checkTicket() {
        const { data } = await (await fetch(`/tickets/${code}/check`)).json();
        if (data.success === true) {
          setTimeout(async () => {
            $("#ticket_checked").show();
            $(".movie-title")[0].innerHTML = "Использован";
          }, 350);
        } else {
          location.reload();
        }
      }

      hammer.on("swipeleft", function () {
        tearSound.play();
        serial.style.transition = "all 0.3s ease-out";
        serial.style.transform = "translateY(10%)";
        canVibrate && window?.navigator?.vibrate([20]);
        setTimeout(() => {
          serial.style.transform = "translate(-80%, 20%)";
          serial.style.opacity = "0";
          checkTicket();
        }, 350);
      });
      hammer.on("swiperight", function () {
        tearSound.play();
        serial.style.transition = "all 0.3s ease-out";
        serial.style.transform = "translateY(10%)";
        canVibrate && window.navigator.vibrate([20]);
        setTimeout(() => {
          serial.style.transform = "translate(80%, 20%)";
          serial.style.opacity = "0";
          checkTicket();
        }, 350);
      });
    </script>
    <% } else{ %>
    <script>
      hammer.on("swipe", function () {
        noTearSound.play();
        serial.style.transition = "all 0.15s ease-out";
        serial.style.transform = "translateY(10%)";
        canVibrate && window.navigator.vibrate([10]);
        setTimeout(() => {
          setTimeout(() => {
            serial.style.transform = "translate(-5%, 10%)";
            setTimeout(() => {
              serial.style.transform = "translate(5%, 10%)";
              canVibrate && window.navigator.vibrate([35, 30, 35, 30, 35]);
              setTimeout(() => {
                serial.style.transform = "translate(-5%, 10%)";
                setTimeout(() => {
                  serial.style.transform = "translate(5%, 10%)";
                  setTimeout(() => {
                    serial.style.transform = "translate(0%, 10%)";
                    setTimeout(() => {
                      serial.style.transform = "";
                    }, 120);
                  }, 100);
                }, 100);
              }, 100);
            }, 100);
          }, 150);
        }, 200);
      });
    </script>
    <% } %>
    <p class="branding" style="z-index: 0">
      Designed by
      <a href="http://wareandsoft.com/">Ware&Soft Digital</a>
    </p>
  </body>
</html>
