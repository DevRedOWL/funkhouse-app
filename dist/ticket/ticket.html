<!DOCTYPE html>
<html lang="en">
  <head>
    <title>FunkHouse Ticket - <%=name%></title>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=0.8, user-scalable=no"
    />
    <meta name="msapplication-TileColor" content="#de407b" />
    <meta name="theme-color" content="#de407b" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="/icons/site.webmanifest" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#f5c3fb" />
    <link
      href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/vendor/meyer-reset.css" />
    <link rel="stylesheet" href="/ticket/style.css" />
  </head>
  <body scroll="no">
    <!-- Heading of the ticket -->
    <div class="ticket" style="z-index: 2; opacity: 0; overflow: hidden">
      <div class="holes-top"></div>
      <div class="title">
        <p class="cinema"><%= name %></p>
        <% if(checked === true){ %>
        <p class="movie-title" style="color: #d64933">Использован</p>
        <% } else { %>
        <p class="movie-title" style="color: #0c7c59">Не использован</p>
        <% } %>
      </div>
      <div
        class="poster"
        style="cursor: pointer; transition: all 0.25s ease-in-out"
      >
        <a id="home_link" href="/"
          ><img src="/splash/splash-min.jpg" alt="Funkhouse"
        /></a>
      </div>
      <div class="info">
        <table>
          <tr>
            <th id="proce-caption">ЦЕНА</th>
            <th id="id-caption">НОМЕР БИЛЕТА</th>
            <th id="social-caption">СОЦ. СЕТЬ</th>
          </tr>
          <tr id="info-values">
            <td id="footer-price"><%= price %></td>
            <td id="footer-id"><%= id %></td>
            <td id="footer-social"><%= social %></td>
          </tr>
        </table>
      </div>
      <div class="holes-lower"></div>
    </div>

    <!-- Icon if checked -->
    <div id="ticket_checked" style="display: none">
      <svg width="40" height="40" transform="scale(2)">
        <circle
          fill="none"
          stroke="#ebebeb"
          stroke-width="2.5"
          cx="20"
          cy="20"
          r="19"
          stroke-linecap="round"
          transform="rotate(-9 20 20)"
          class="circle"
        ></circle>
        <polyline
          fill="none"
          stroke="#fff"
          stroke-width="3"
          points="8.8,21.4 17.3,28.4 30.4,13.8"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="tick"
        ></polyline>
      </svg>
      <h2 id="confirmed" style="color: #fff">Билет проверен</h2>
    </div>

    <!-- After Cropline -->
    <div
      id="cropline"
      class="ticket"
      style="margin: -1px auto 0 auto; z-index: 1; opacity: 0"
    >
      <div class="holes-lower"></div>
      <div id="serial" class="serial">
        <img
          class="qrImage"
          src="/tickets/<%=qr%>/qr?bg=00000000"
          alt=""
          onClick="toggleBlur()"
        />
      </div>
    </div>
    <script src="/vendor/jq.js"></script>
    <script src="/vendor/hammer.js"></script>

    <script>
      const checked = JSON.parse("<%=checked%>");
      const code = "<%=qr%>";
      const social = "<%=social%>";
      const id = "<%=id%>";

      $("document").ready(() => {
        // Animate ticket
        $(".ticket").css("opacity", 1);
      });

      // Ticket type design
      if (social !== "INSTAGRAM" && social !== "TELEGRAM" && social !== "VK") {
        document.getElementById("social-caption").innerHTML = "ТИП БИЛЕТА";
      }

      const serial = document.getElementById("cropline");
      const hammer = new Hammer(serial);

      // Set random letter for id
      document.getElementById("footer-id").innerHTML = `${String.fromCharCode(
        1040 - 5 + ("<%=name%>".length % 33)
      )}${id}`;

      // Prepare intercations
      const tearSound = new Audio("/ticket_tear.mp3");
      const noTearSound = new Audio("/bus_ticket_tear.mp3");
      const canVibrate = window?.navigator?.vibrate;

      // Set my ticket
      if (!localStorage.getItem("ticket")) {
        localStorage.setItem("ticket", "<%=qr%>");
      }

      // Blur the QR
      const qrCode = document.getElementsByClassName("qrImage")[0];
      if (localStorage.getItem("blur") === "true") {
        history.pushState(null, null, "/");
        qrCode.classList.add("blur");
      }
      function toggleBlur() {
        console.log(localStorage.getItem("blur"));
        if (localStorage.getItem("blur") === "true") {
          localStorage.setItem("blur", false);
          history.pushState(null, null, "/tickets/<%=qr%>");
          qrCode.classList.remove("blur");
        } else {
          qrCode.classList.add("blur");
          history.pushState(null, null, "/");
          localStorage.setItem("blur", true);
        }
      }
    </script>

    <% if(premium === true) { %>
    <!-- Premium branding -->
    <script>
      $("document").ready(() => {
        $(".ticket").addClass("bg-gold");
        $(".movie-title").css("color", "#0e0e0e");
        $(".cinema").css("color", "#785712");
        // document.documentElement.style.setProperty("--bg-color", "#1e1e1e");
        $("svg").children()[0].setAttribute("stroke", "#b9861f");
        $("svg").children()[1].setAttribute("stroke", "#f4b32f");
        $("#confirmed").css("color", "#f4b32f");
        $("#footer-social").text("Premium");
        $("#info-values").css("color", "#fdb931");
        $(".branding").css("color", "#fefefe");
        $(".branding a").css("color", "#f4b32f");
      });
    </script>
    <% } %> <% if(isAdmin === true && checked === false) { %>
    <script>
      async function checkTicket() {
        const { data } = await (await fetch(`/tickets/${code}/check`)).json();
        if (data.success === true) {
          setTimeout(async () => {
            $("#ticket_checked").show();
            $(".movie-title")[0].innerHTML = "Использован";
          }, 350);
        } else {
          location.reload();
        }
      }

      hammer.on("swipeleft", function () {
        tearSound.play();
        serial.style.transition = "all 0.3s ease-out";
        serial.style.transform = "translateY(10%)";
        canVibrate && window.navigator.vibrate([20]);
        setTimeout(() => {
          serial.style.transform = "translate(-80%, 20%)";
          serial.style.opacity = "0";
          checkTicket();
        }, 350);
      });
      hammer.on("swiperight", function () {
        tearSound.play();
        serial.style.transition = "all 0.3s ease-out";
        serial.style.transform = "translateY(10%)";
        canVibrate && window.navigator.vibrate([20]);
        setTimeout(() => {
          serial.style.transform = "translate(80%, 20%)";
          serial.style.opacity = "0";
          checkTicket();
        }, 350);
      });
    </script>
    <% } else{ %>
    <script>
      hammer.on("swipe", function () {
        noTearSound.play();
        serial.style.transition = "all 0.15s ease-out";
        serial.style.transform = "translateY(10%)";
        canVibrate && window.navigator.vibrate([10]);
        setTimeout(() => {
          setTimeout(() => {
            serial.style.transform = "translate(-5%, 10%)";
            setTimeout(() => {
              serial.style.transform = "translate(5%, 10%)";
              canVibrate && window.navigator.vibrate([35, 30, 35, 30, 35]);
              setTimeout(() => {
                serial.style.transform = "translate(-5%, 10%)";
                setTimeout(() => {
                  serial.style.transform = "translate(5%, 10%)";
                  setTimeout(() => {
                    serial.style.transform = "translate(0%, 10%)";
                    setTimeout(() => {
                      serial.style.transform = "";
                    }, 120);
                  }, 100);
                }, 100);
              }, 100);
            }, 100);
          }, 150);
        }, 200);
      });
    </script>
    <% } %>

    <p
      class="branding"
      style="
        position: absolute;
        bottom: 22px;
        text-align: center;
        font-size: 11px;
        font-weight: 500;
        z-index: 0;
        color: #fefefe;
        opacity: 0.6;
        font-family: sans-serif;
        left: 0;
        right: 0;
        margin-left: auto;
        margin-right: auto;
      "
    >
      Designed by
      <a
        href="http://wareandsoft.com/"
        style="color: #de407b; outline: none; text-decoration: none"
        >Ware&Soft Digital</a
      >
    </p>
  </body>

  <% if(name === "Михаил Кашинский") { %>
  <!-- KASHCOIN SPECIAL -->
  <link rel="stylesheet" href="/ticket/kashcoin.css" />
  <div id="kashcoin" style="opacity: 0; left: 0; top: 0">
    <img src="/ticket/kashcoin.png" alt="Пиздабольский кубик рубика" />
  </div>
  <script>
    let opaCounter = 0;
    const opaSound = new Audio("/ticket/kashcoin.mp3");
    document.addEventListener("DOMContentLoaded", function () {
      toggleBlur = () => {};
      document.getElementById("kashcoin").style.opacity = "1";
      document.getElementById("kashcoin").addEventListener("touchstart", () => {
        opa();
      });
      document.getElementById("home_link").href = "#";
      document.getElementById("id-caption").innerHTML = 'Счетчик "ОПА"';
      document.getElementById("footer-id").innerHTML = `Поймай Мишаню`;
      console.log("ОПА");

      const cringeNames = [
        "Миша",
        "Михаил",
        "Мишаня",
        "Мишанька",
        "Мишап",
        "Мишель",
        "Михуил",
        "Мишаньчик",
        "Михайло",
        "Майкл",
        "MkSmc",
      ];
      const cringeSurames = [
        "Каш",
        "Куни",
        "Кринжинский",
        "Шафутинский",
        "Кашинский",
        "КашCoin",
        "Студенческий",
        "Отчисленский",
        "Фейсерский",
        "Музклубский",
        "Кашперовский",
        "Кальянский",
        "Фрегатик",
        "Зеленый Дракон",
        "Санстрайковский",
        "Градьюэйтович",
        "DK-шинский",
      ];
      setInterval(() => {
        document.getElementsByClassName("cinema")[0].innerHTML =
          cringeNames[Math.floor(Math.random() * cringeNames.length)] +
          " " +
          cringeSurames[Math.floor(Math.random() * cringeSurames.length)];
      }, 1000);
    });

    function opa() {
      setTimeout;
      opaSound.cloneNode(true).play();
      opaCounter++;
      document.getElementById("footer-id").innerHTML = opaCounter;
    }
  </script>
  <!-- KASHCOIN SPECIAL -->
  <% } %>
</html>
