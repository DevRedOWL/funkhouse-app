<!DOCTYPE html>
<html lang="en">
  <head>
    <title>FH Ticket Checker</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#da532c" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
    <link rel="manifest" href="/icons/site.webmanifest" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#f5c3fb" />
    <link
      rel="stylesheet"
      href="/vendor/bootstrap.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <script src="/vendor/jq.js"></script>
    <script src="/vendor/smart_placeholders.js"></script>
    <script src="/vendor/parsley.js"></script>
    <link
      rel="stylesheet"
      href="/vendor/fa.css"
    />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div
      class="modal fade"
      id="sellTicketModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="sellTicketModalLabel"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="sellTicketModalLabel">Новая продажа</h4>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="socialDropdown">Выберите социальную сеть:</label>
                <select class="form-control" id="socialDropdown">
                  <option>Instagram</option>
                  <option>Telegram</option>
                  <option>Vk</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="sellSubmit">
              Подтвертдить продажу
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <h1 style="margin-bottom: 16px">Проверка билета</h1>
      <div class="searchInput" style="margin-bottom: 16px">
        <input type="text" placeholder="Имя / Фамилия" />
        <div class="resultBox">
          <!-- here list are inserted from javascript -->
        </div>
        <div class="icon"><i class="fas fa-search"></i></div>
      </div>
      <button class="check" onClick="sellAndCheck()">
        Отметить проход
        <div class="icon"><i class="fas fa-check"></i></div>
      </button>
      <button class="sell" onClick="sell()">
        Продажа
        <div class="icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
      </button>
      <div id="ticket_checked" style="display: none">
        <svg width="40" height="40" transform="scale(2)">
          <circle
            fill="none"
            stroke="#3BA99C"
            stroke-width="2.5"
            cx="20"
            cy="20"
            r="19"
            stroke-linecap="round"
            transform="rotate(-9 20 20)"
            class="circle"
          ></circle>
          <polyline
            fill="none"
            stroke="#21897E"
            stroke-width="3"
            points="8.8,21.4 17.3,28.4 30.4,13.8"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="tick"
          ></polyline>
        </svg>
        <h2>Проход сохранен</h2>
      </div>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <script>
      // getting all required elements
      const searchInput = document.querySelector(".searchInput");
      const input = searchInput.querySelector("input");
      const resultBox = searchInput.querySelector(".resultBox");
      const icon = searchInput.querySelector(".icon");
      let linkTag = searchInput.querySelector("a");
      let webLink;

      // if user press any key and release
      input.onkeyup = async (e) => {
        let userData = e.target.value; //user enetered data
        let emptyArray = [];
        if (userData.length > 0) {
          const { data } = await (
            await fetch(`/tickets/find/${userData}`)
          ).json();
          console.log("Found Tickets:", data);
          emptyArray = data.map((data) => {
            // passing return data inside li tag
            return (data = `<li ticketId="${data.code}">${data.name}</li>`);
          });
          searchInput.classList.add("active"); //show autocomplete box
          showSuggestions(emptyArray);
          let allList = resultBox.querySelectorAll("li");
          for (let i = 0; i < allList.length; i++) {
            // adding onclick attribute in all li tag
            allList[i].setAttribute("onclick", "select(this)");
          }
        } else {
          showSuggestions([]);
          searchInput.classList.remove("active"); //hide autocomplete box
        }
      };

      function select(item) {
        window.location.href = `/tickets/${item.getAttribute("ticketId")}`;
        console.log(item.getAttribute("ticketId"));
      }

      function showSuggestions(list) {
        let listData;
        if (!list.length) {
          listData = "";
          searchInput.classList.remove("active");
        } else {
          listData = list.join("");
        }
        resultBox.innerHTML = listData;
      }

      // Продажа билета без отметки
      function sell() {
        if (input.value.length > 0) {
          $("#sellTicketModal").modal();
        }
      }

      $(document).ready(() => {
        $("#sellSubmit").click(() => {
          const social = $("#socialDropdown").val();
          const name = input.value;
          fetch("/tickets/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, social, checked: false }),
          })
            .then((response) => response.json())
            .then((data) => {
              $("#sellTicketModal").modal("hide");
              setTimeout(
                () => (window.location.href = `/tickets/${data.data.code}`),
                500
              );
            })
            .catch((error) => {
              $("#sellTicketModal").hide();
              console.error(error);
            });
        });
      });

      // Продажа на месте
      function sellAndCheck() {
        const name = input.value;
        if (input.value.length > 0) {
          fetch("/tickets/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, checked: true }),
          })
            .then((response) => response.json())
            .then((data) => {
              $("#ticket_checked").show();
              input.value = "";
              setTimeout(() => {
                $("#ticket_checked").hide();
              }, 4000);
            })
            .catch((error) => {
              console.error(error);
            });
        }
      }
    </script>
  </body>
</html>
